<!doctype html>
<html lang="en-us">
<head>
	<meta charset="utf-8">
	<title>[Add a descriptive title here]</title>
	<meta name="viewport" content="width=device-width">
	<meta name="og:title" content="[Keep short; used as title in any teasers of this demo on dev.microsoftedge.com]">
	<meta name="description" content="[Used as description in any teasers of this demo on dev.microsoftedge.com]">
	<meta name="keywords" content="[First value is category for dev.microsoftedge.com/demos, following comma-separated values are tags]">
	<meta name="author" content="[your Github handle]">

	<link rel="stylesheet" href="https://az813057.vo.msecnd.net/styles/fonts-full-20180102.css">
	<link rel="stylesheet" href="styles/demo-template.css">
	<link rel="stylesheet" href="styles/push-notifications.css">
	<script src="/scripts/script.js"></script>
</head>
<body>
	<header class="c-nav-bar">
		<div class="l-contain c-nav-bar__contain" data-menu>
			<nav class="c-nav-bar__breadcrumb" aria-label="breadcrumbs">
				<ul class="u-simple-list">
					<li class="c-nav-bar__index"><a href="https://developer.microsoft.com/en-us/microsoft-edge/testdrive/" class="c-nav-bar__more">Microsoft Edge Demos</a></li>
					<li class="c-nav-bar__title"><span class="u-sr-only">Current demo:</span>Push Notifications</li>
				</ul>
			</nav>
			<nav class="c-toc">
				<button class="c-toc__btn" id="js-nav-btn" aria-haspopup="true" aria-expanded="false" aria-controls="js-nav-items" aria-label="Demo contents">
					Contents <svg class="c-toc__arrow" xmlns="http://www.w3.org/2000/svg" width="12" height="12"><path fill="none" stroke="#FFF" stroke-miterlimit="10" d="M12 3L6 9 0 3"/></svg>
				</button>
				<ul class="c-toc__items" id="js-nav-items"  role="group" aria-hidden="true"></ul>
			</nav>
		</div>
	</header>
	<main role="main">
		<div class="intro l-section--banner--dark">
			<div class="l-contain">
                <section class="intro__section">
                    <h1 class="intro__heading">Push Notifications</h1>
                    <div class="intro__section__overview">
                        <p class=""></p>
                        <p></p>
                        <p></p>
                    </div>
                    <button class="">Initiate Push</button>
                </section>
                <section class="intro__section l-section">
                    <h2>The different pieces</h2>
                    <div class="intro__section__highlight l-subsection">
                        <p class="highlight">
                            At a high-level, there are four major pieces to the push puzzle: the app’s server, the app’s page, the notification 
                            service’s server, and of course the user agent or browser. Each of these different pieces play a role in subscribing 
                            for the push message, sending push message updates, showing a notification and ultimately opening a page when that 
                            notification is clicked. 
                        </p>
                    </div>
                    <div class="l-flex--halves l-subsection">
                        <div class="card card--right">
                            <h3>Server Side</h2>
                            <div class="card--illustration">
                                <img src="images/leo-server-side.svg" role="presentation" />
                            </div>
                            <div class="card--bottom">
                                <p class="card--caption">
                                    The positions of the celestial objects in the sky (or in the cloud) are used to divine messages 
                                    about terrestrial events. One could say that the celestial objects provide notifications about 
                                    these events if called upon. For our guide, the app server and notification service’s server are 
                                    represented by the zodiac and other celestial objects.
                                </p>
                            </div>
                        </div>
                        <div class="card card--left">
                            <h3>Client Side</h2>
                            <div class="card--illustration">
                                    <img src="images/client-side.svg" role="presentation" />
                            </div>
                            <div class="card--bottom">
                                <p class="card--caption">
                                    The celestial objects are called upon by an astrologer to show their messages about terrestrial events. 
                                    Our user is an astrologer who receives messages from the celestial objects via her device.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="l-section">
                    <p>charts</p>
                </section>
			</div>
        </div>
        <section class="l-section">
            <h2>Set up your server</h2>
            <div class="l-contain">
                <div class="l-flex--guide l-subsection">
                    <div class="guide-col-main">
                        <p>To start, you’ll first need to make sure your web server is setup to send pushes. We’ll be using a node.js server and take advantage of the open-source web-push library so that we don’t have to worry about the encryption details involved with sending a push.</p>
                        <p>We’ll need to specify the VAPID keys that will allow identifications between our app’s server and the notification server (e.g. Firebase Cloud Messaging (FCM), Mozilla Cloud Services (MCS), and Windows Push Notification Service (WNS) depending on which browser is being used). You only need to set up the VAPID keys once which can be generated easily:</p>
<pre><code>var webpush = require('web-push'); 
console.log(webpush.generateVAPIDKeys());</code></pre>
                        <p>Once they’re generated, you can use them for as long as you need to by setting the vapidKeys variable to what you just got when calling <code>generateVAPIDKeys()</code>:</p>
<pre><code>var vapidKeys = { publicKey: 'BL6As_YCGHPf3ZeDbklyVxgvJVb4Tr5qjZFS-J7XzkT5zQNghd9iUBUsqSlVO5znwTsZZrEOx8JFRDJc1JmkymA', 
privateKey: 'GnMVDgbtZrqs7tgKEkJaV5aZF8cVjoq7Ncz_TEVI_lo'}; 
               
webpush.setVapidDetails( 
    'mailto:myaccount@outlook.com', 
    vapidKeys.publicKey, 
    vapidKeys.privateKey 
);</code></pre>
                        <p>We’ll need to set up a few endpoints on our server so that we can provide the public key to our site. The public key will be used when subscribing for push messages so that the notifications server (e.g. WNS or FCM) can know that we are who we say we are when we send subsequent push messages.</p>
                        <p>We’ll also need an endpoint that will allow us to store the subscription details for a user so that we’ll be able to push messages to them from our app’s server.</p>
                    </div>
                </div>
                <div class="l-flex--guide--callout l-subsection">
                    <div class="guide-col-side callout-text callout-light">
                        <p class="highlight">In our example, we are going to be sending star trivia push updates to each user that is subscribed daily at 7am Pacific Time. This will be done in a cron job that runs on the server. Therefore, it’s important that we store the subscription information on the server so that we can send this update whenever we need to.</p>
                    </div>
                    <div class="guide-col-main--alt callout-img callout-light">

                    </div>
                </div>
                <div class="l-flex--guide l-subsection">
                    <div class="guide-col-main">
                        <p>In other examples, you can send pushes when something changes in the database, or after something changes on the site. For instance, if your site allows users to message each other and someone messages a user, you will want to send a push to that user so that they know they just got a message. Be aware that the goal is to produce a notification that will have a good chance of being clicked by the user, otherwise it might defeat the purpose. For instance, it might make more sense to not send any push messages to a user that is not on the page already since it might annoy them to get notifications when they’re already on your page. This is something that you’ll need to coordinate with the server to ensure that the user is not getting notifications when they really shouldn’t be getting them.</p>
                        <p>Now that we have the server all set up, let’s move on to making the actual page that will subscribe for the push!</p>
                    </div>
                </div>
            </div>
        </section>
        <section class="l-section l-section--banner--dark">
            <h2>Set up your web page</h2>
            <div class="l-contain">
                <div class="l-flex--guide l-subsection">
                    <div class="guide-col-main">
                        <p>When the page loads, the first thing you’ll want to do is get the public key from the application server so that you can set up the push subscription. We can do this by setting up an endpoint on our server that returns the public key.</p>
<pre><code>if (navigator.serviceWorker) {fetch('./api/key') 
    .then(function(res) { 
        res.json().then(function(data) { 
            registerPush(data.key); 
        }); 
    }); 
} </code></pre>
                        <p>With the public key in hand, as before, we’ll need to install the service worker and also create a push subscription.</p>
<pre><code>navigator.serviceWorker.register('service-worker.js'); 
navigator.serviceWorker.ready.then(function(registration) { 
return reg.pushManager.getSubscription() 
    .then(function(subscription) { 
        if (subscription) { 
            return subscription; 
        } 

        return registration.pushManager.subscribe({ 
            userVisibleOnly: true, 
            applicationServerKey: urlBase64ToUint8Array(appPubkey) 
        }); 
    })  
    .then(function(subscription) { 
        sub = subscription.toJSON(); 
    }); 
}); 
} 

function urlBase64ToUint8Array(base64String) { 
const padding = '='.repeat((4 - base64String.length % 4) % 4); 
const base64 = (base64String + padding) 
.replace(/\-/g, '+') 
.replace(/_/g, '/'); 

const rawData = window.atob(base64); 
const outputArray = new Uint8Array(rawData.length); 

for (let i = 0; i < rawData.length; ++i)  { 
outputArray[i] = rawData.charCodeAt(i); 
} 

return outputArray;</code></pre>
                        <p>We’ll need to make sure that we have an active service worker before we attempt to subscribe for push. We can do this by using navigator.serviceWorker.ready which will resolve when a service worker is active.</p>
                    </div>
                </div>
                <div class="l-flex--guide--callout l-subsection">
                    <div class="guide-col-side callout-text callout-dark">
                        <p class="highlight">At this point, before a new push subscription is created, the browser will check whether the user granted permission to receive notifications. If not, the user will be prompted by the browser for permission.</p>
                    </div>
                    <div class="guide-col-main--alt callout-img callout-dark">

                    </div>
                </div>
                <div class="l-flex--guide l-subsection">
                    <div class="guide-col-main">
                        <p>To create a push subscription, you’ll need to set the userVisibleOnly option to “true” – meaning a notification must be shown as a result of a push – and provide a valid applicationServerKey. If there is already a push subscription, there is no need to subscribe again. That said, we’ll want to first check if there’s an existing push subscription and use that first.</p>
                        <p>At any point when a push is received by the client, a corresponding service worker is run to handle the push event. As part of this push handling, a notification must be shown so that the user understands that something is happening in the background. In the service worker (sw.js), we will handle the onpush event and show a notification:</p>
<pre><code>self.onpush = function(event) { 
    event.waitUntil( 
        registration.showNotification('WEATHER ADVISORY', { 
            body: event.data ? event.data.text() : 'no payload', 
            icon: 'icon.png' 
        }) 
    ); 
} </code></pre>
                        <p>After a notification is shown, there is still the matter of dealing with when it’s been clicked. As such, we need to have another event listener in the service worker that would handle this case. In the same service worker, we will handle the onnotificationclick event to close the notification and then open a new window for our site:</p>
<pre><code>self.onnotificationclick = function(event) { 
    event.notification.close(); 
    event.waitUntil(clients.openWindow('weather/advisory')); 
} </code></pre>
                        <p>You’re also able to sort through the already open windows and focus one of those, or perhaps even navigate an existing window. </p>
                    </div>
                </div>
            </div>
        </section>
        <section class="l-section">
            <h2>Try it out!</h2>
            <div class="l-contain">
                <div class="l-flex--guide--callout l-subsection">
                        <div class="guide-col-side callout-text callout-light">
                            <p class="highlight">Great, so now we have a fully working push site. It’s time for you to get your hands dirty and see what you can come up with. Make sure you upgrade to the latest version of Windows which comes with Edge that supports service workers and push. We’d love to hear from you if you have any questions or find any bugs. Please let us know! </p>
                        </div>
                        <div class="guide-col-main--alt callout-img callout-light">
    
                        </div>
                    </div>
	</main>
	<footer class="l-section l-section--banner c-outro" role="contentinfo" aria-label="Demo credits">
		<div class="l-contain">
			<div class="c-outro__byline">
				<p><a href="https://developer.microsoft.com/en-us/microsoft-edge/testdrive/" class="c-nav-bar__more">A demo</a> by Microsoft Edge</p>
				<p>Contributors: <a href="">[Firstname Lastname]</a>, <a href="">Another Person</a></p>
			</div>
			<a href="[Github URL]" class="c-outro__github" aria-label="Explore code on Github">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill-rule="evenodd" clip-rule="evenodd" fill="#FFF" d="M10 .2C4.5.2 0 4.7 0 10.2c0 4.4 2.9 8.2 6.8 9.5.5.1.7-.2.7-.5v-1.7c-2.8.6-3.4-1.3-3.4-1.3-.4-1.1-1.1-1.5-1.1-1.5-.9-.6.1-.6.1-.6 1 .1 1.5 1 1.5 1 .9 1.6 2.4 1.2 2.9.9.1-.6.3-1.1.6-1.3-2.1-.3-4.5-1.1-4.5-5 0-1.1.4-2 1-2.7-.1-.2-.4-1.2.1-2.6 0 0 .8-.3 2.7 1 .9-.2 1.8-.3 2.6-.3s1.7.1 2.5.3c1.9-1.3 2.7-1 2.7-1 .5 1.4.2 2.4.1 2.6.6.7 1 1.6 1 2.7 0 3.8-2.3 4.7-4.6 4.9.4.3.7.9.7 1.9v2.7c0 .3.2.6.7.5 4-1.3 6.8-5.1 6.8-9.5.1-5.5-4.4-10-9.9-10z"/></svg><span>Explore code</span>
			</a>
		</div>
	</footer>
	<script src="scripts/demo-template.js"></script>
	<script src="scripts/your-demo-name.js"></script>
</body>
</html>
